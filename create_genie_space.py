# Databricks notebook source
# MAGIC %md
# MAGIC # Create Genie Space for Vantage RWE
# MAGIC 
# MAGIC This notebook automates the creation of a Databricks Genie Space optimized for OMOP CDM analytics.
# MAGIC 
# MAGIC ## Prerequisites
# MAGIC Before running this notebook, ensure you have:
# MAGIC - **OMOP CDM data** loaded in a catalog and schema
# MAGIC - **SQL Warehouse** running and accessible
# MAGIC - **Warehouse ID** from your SQL Warehouse connection details
# MAGIC 
# MAGIC ## Required Parameters
# MAGIC You will need to provide three parameters in Step 3:
# MAGIC - **catalog_name**: Your OMOP catalog name (default: `vantage_rwe`)
# MAGIC - **schema_name**: Your OMOP schema name (default: `omop`)
# MAGIC - **warehouse_id**: Your SQL Warehouse ID (find in SQL Warehouse → Connection Details)
# MAGIC 
# MAGIC ## Steps
# MAGIC Follow these 5 steps in order:
# MAGIC 1. Install dependencies and restart Python
# MAGIC 2. Create widget parameters
# MAGIC 3. **UPDATE** widget values with your configuration
# MAGIC 4. Create Genie Space
# MAGIC 5. Capture Genie Space ID (save this for app deployment)
# MAGIC 
# MAGIC ## Output
# MAGIC The notebook will output a **Genie Space ID** - save this value for use in the Vantage RWE application deployment.
# MAGIC 
# MAGIC For more details, see: [Genie Setup Guide](./docs/GENIE_SETUP.md)

# COMMAND ----------

# MAGIC %md
# MAGIC # Step 1
# MAGIC ## Run pip install, restart Python

# COMMAND ----------

# MAGIC %pip install --upgrade databricks-sdk
# MAGIC dbutils.library.restartPython()

# COMMAND ----------

# MAGIC %md
# MAGIC # Step 2
# MAGIC ## Create widget parameters

# COMMAND ----------

dbutils.widgets.text("catalog_name", "vantage_rwe", "Catalog Name")
dbutils.widgets.text("schema_name", "omop", "Schema Name")
dbutils.widgets.text("warehouse_id", "", "Warehouse ID")


# COMMAND ----------

# MAGIC %md
# MAGIC # Step 3
# MAGIC ## Update widget parameters with Catalog, Schema, Warehouse ID

# COMMAND ----------

# MAGIC %md
# MAGIC # Step 4
# MAGIC ## Run code below to create Genie Space

# COMMAND ----------

CATALOG_NAME = dbutils.widgets.get("catalog_name")
SCHEMA_NAME = dbutils.widgets.get("schema_name")
WAREHOUSE_ID = dbutils.widgets.get("warehouse_id")

# COMMAND ----------

from databricks.sdk import WorkspaceClient
from databricks.sdk.service.dashboards import GenieAPI

w = WorkspaceClient()

GENIE_TITLE = "Vantage RWE Space2"
GENIE_DESCRIPTION = "The OMOP Common Data Model (CDM) is an open-source standard for organizing diverse healthcare data (like EHRs, claims) into a unified format, enabling large-scale, reproducible research across different institutions.This includes several tables from that CDM"
SERIALIZED_SPACE = f"""{{\"version\": 2,\"data_sources\": {{\"tables\": [{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept\",\"column_configs\": [{{\"column_name\": \"concept_class_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"concept_code\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"concept_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"concept_name\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"domain_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"invalid_reason\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"standard_concept\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"valid_end_date\",\"enable_format_assistance\": true}},{{\"column_name\": \"valid_start_date\",\"enable_format_assistance\": true}},{{\"column_name\": \"vocabulary_id\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept_ancestor\",\"column_configs\": [{{\"column_name\": \"ancestor_concept_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"descendant_concept_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"max_levels_of_separation\",\"enable_format_assistance\": true}},{{\"column_name\": \"min_levels_of_separation\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.condition_occurrence\",\"column_configs\": [{{\"column_name\": \"CONDITION_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_END_DATE\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_END_DATETIME\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_OCCURRENCE_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"CONDITION_START_DATE\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_START_DATETIME\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_STATUS_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"CONDITION_STATUS_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"CONDITION_TYPE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"PERSON_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"PROVIDER_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"STOP_REASON\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"VISIT_DETAIL_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"VISIT_OCCURRENCE_ID\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.drug_exposure\",\"column_configs\": [{{\"column_name\": \"DAYS_SUPPLY\",\"enable_format_assistance\": true}},{{\"column_name\": \"DOSE_UNIT_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"DRUG_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_EXPOSURE_END_DATE\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_EXPOSURE_END_DATETIME\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_EXPOSURE_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_EXPOSURE_START_DATE\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_EXPOSURE_START_DATETIME\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"DRUG_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"DRUG_TYPE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"LOT_NUMBER\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"PERSON_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"PROVIDER_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"QUANTITY\",\"enable_format_assistance\": true}},{{\"column_name\": \"REFILLS\",\"enable_format_assistance\": true}},{{\"column_name\": \"ROUTE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"ROUTE_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"SIG\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"STOP_REASON\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"VERBATIM_END_DATE\",\"enable_format_assistance\": true}},{{\"column_name\": \"VISIT_DETAIL_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"VISIT_OCCURRENCE_ID\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.location\",\"column_configs\": [{{\"column_name\": \"ADDRESS_1\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"ADDRESS_2\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"CITY\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"COUNTY\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"LOCATION_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"LOCATION_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"STATE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"ZIP\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"country_concept_id\",\"enable_format_assistance\": true}},{{\"column_name\": \"country_source_value\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"latitude\",\"enable_format_assistance\": true}},{{\"column_name\": \"longitude\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.person\",\"column_configs\": [{{\"column_name\": \"BIRTH_DATETIME\",\"enable_format_assistance\": true}},{{\"column_name\": \"CARE_SITE_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"DAY_OF_BIRTH\",\"enable_format_assistance\": true}},{{\"column_name\": \"ETHNICITY_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"ETHNICITY_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"ETHNICITY_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"GENDER_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"GENDER_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"GENDER_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"LOCATION_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"MONTH_OF_BIRTH\",\"enable_format_assistance\": true}},{{\"column_name\": \"PERSON_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"PERSON_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"PROVIDER_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"RACE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"RACE_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"RACE_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"YEAR_OF_BIRTH\",\"enable_format_assistance\": true}}]}},{{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"column_configs\": [{{\"column_name\": \"CARE_SITE_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"DEA\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"GENDER_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"GENDER_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"GENDER_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"NPI\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"PROVIDER_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"PROVIDER_NAME\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"PROVIDER_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"SPECIALTY_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"SPECIALTY_SOURCE_CONCEPT_ID\",\"enable_format_assistance\": true}},{{\"column_name\": \"SPECIALTY_SOURCE_VALUE\",\"enable_format_assistance\": true,\"enable_entity_matching\": true}},{{\"column_name\": \"YEAR_OF_BIRTH\",\"enable_format_assistance\": true}}]}}]}},\"instructions\": {{\"text_instructions\": [{{\"id\": \"01f0eb127c331ac18897a8a4c2a88dc3\",\"content\": [\"- OMOP Data Model Overview: What users should know: The OMOP CDM organizes observational health data into standardized tables using controlled vocabularies. All clinical events link to patients via person_id and most link to healthcare encounters via visit_occurrence_id. Analysis should use *_concept_id fields (not source codes) because these contain standardized vocabulary concepts.\\n\",\"​\\n\",\"Standard vs. Non-Standard Concepts:\\n\",\"- All *_concept_id fields (e.g., condition_concept_id, drug_concept_id) must contain Standard Concepts with standard_concept = 'S'\\n\",\"- Standard concepts are used for all analysis and network studies\\n\",\"- Non-standard concepts represent source codes and map TO standard concepts via the \\\"Maps to\\\" relationship in CONCEPT_RELATIONSHIP\\n\",\"- Query translations: Always filter WHERE standard_concept = 'S' when querying CONCEPT table directly\\n\",\"​\\n\",\"Concept ID ranges:\\n\",\"- Concept IDs < 2,000,000,000: OHDSI-maintained standard vocabularies\\n\",\"- Concept IDs ≥ 2,000,000,000: Local custom concepts\\n\",\"- Concept ID = 0: \\\"No matching concept\\\" or NULL equivalent\\n\",\"\\n\",\"Standard vocabulary mappings by domain:\\n\",\"- \\\"Domain\\\" | \\\"Source Vocabularies\\\" | \\\"OMOP Standard Vocabulary\\\"\\n\",\"- Conditions | ICD-9-CM, ICD-10-CM, ICD-10 | SNOMED-CT\\n\",\"- Drugs | NDC, GCN, RxNorm Extension | RxNorm\\n\",\"- Measurements | LOINC, institutional codes | LOINC\\n\",\"- Procedures | ICD-9-Proc, CPT-4, ICD-10-PCS | SNOMED-CT\\n\",\"- Visits | CPT, place of service codes | Visit domain concepts\\n\",\"\\n\",\"- Using hierarchies for broader queries: When users ask about condition categories (e.g., \\\"all diabetes types\\\"), use the CONCEPT_ANCESTOR table to find descendant concepts. The ancestor_concept_id represents the parent category, and descendant_concept_id represents all child concepts including the ancestor itself\\n\",\"\\n\",\"- Critical rule: Always use *_concept_id fields for analysis. Source fields are for reference only.\\n\",\"\\n\",\"Most clinical events should link to VISIT_OCCURRENCE:\\n\",\"- visit_occurrence_id connects events to healthcare encounters\\n\",\"- Visit types include: Inpatient, Outpatient, Emergency Room, Long-term care, Telehealth\\n\",\"- Multi-day visits cannot overlap (except at start/end boundaries)\\n\",\"- Some events (pharmacy claims) may have NULL visit_occurrence_id\\n\",\"\\n\",\"Missing time components:\\n\",\"- When time is unknown, convention is midnight (00:00:00)\\n\",\"- Use *_date fields when time-of-day is irrelevant\\n\",\"- Use *_datetime fields for precise timing (e.g., medication administration times)\\n\",\"\\n\",\"For \\\"patient cohort\\\" questions:\\n\",\"- ​Start with initial event (index date) from appropriate domain table\\n\",\"- Apply inclusion/exclusion criteria using temporal relationships\\n\",\"- Check observation period for required continuous enrollment\\n\",\"- Consider visit type restrictions (inpatient only, outpatient only)\\n\",\"- Example: \\\"New users of lisinopril with 365 days prior observation and no prior ACE inhibitor use\\\"\\n\",\"\\n\",\"For \\\"medication history\\\" questions:\\n\",\"- ​Use DRUG_EXPOSURE for individual fills/administrations\\n\",\"- Join to CONCEPT to get drug names\\n\",\"- Filter drug_concept_id with vocabulary_id = 'RxNorm' and standard_concept = 'S'\\n\",\"- For therapeutic class queries, use CONCEPT_ANCESTOR to find all drugs in class\\n\",\"- For adherence/persistence, use DRUG_ERA with gap_days field\"]}}],\"example_question_sqls\": [{{\"id\": \"01f0eb128bf31094b8bc6a6ff150f48a\",\"question\": [\"what patients have been exposed to Furosemide?\"],\"sql\": [\"SELECT person_id, MIN(drug_exposure_start_date) AS drug_exposure_start_date\\n\",\"FROM {CATALOG_NAME}.{SCHEMA_NAME}.drug_exposure\\n\",\"WHERE drug_concept_id IN (\\n\",\"SELECT descendant_concept_id FROM {CATALOG_NAME}.{SCHEMA_NAME}.concept_ancestor WHERE ancestor_concept_id IN ('1719286')\\n\",\")\\n\",\"GROUP BY person_id\"]}},{{\"id\": \"01f0f3c0b1b11274881ad69143304cad\",\"question\": [\"Show me patients with Type 2 Diabetes who were prescribed Metformin\"],\"sql\": [\"WITH t2dm_patients AS (\\n\",\"SELECT person_id, MIN(condition_start_date) AS t2dm_diagnosis_date\\n\",\"FROM {CATALOG_NAME}.{SCHEMA_NAME}.condition_occurrence\\n\",\"WHERE condition_concept_id IN (\\n\",\"SELECT descendant_concept_id FROM {CATALOG_NAME}.{SCHEMA_NAME}.concept_ancestor WHERE ancestor_concept_id = 201826\\n\",\")\\n\",\"GROUP BY person_id\\n\",\"),\\n\",\"metformin_patients AS (\\n\",\"SELECT person_id, MIN(drug_exposure_start_date) AS metformin_exposure_date\\n\",\"FROM {CATALOG_NAME}.{SCHEMA_NAME}.drug_exposure\\n\",\"WHERE drug_concept_id IN (\\n\",\"SELECT descendant_concept_id FROM {CATALOG_NAME}.{SCHEMA_NAME}.concept_ancestor WHERE ancestor_concept_id = 1503297\\n\",\")\\n\",\"GROUP BY person_id\\n\",\")\\n\",\"SELECT t2dm_patients.person_id, t2dm_patients.t2dm_diagnosis_date, metformin_patients.metformin_exposure_date\\n\",\"FROM t2dm_patients\\n\",\"JOIN metformin_patients ON t2dm_patients.person_id = metformin_patients.person_id\"]}},{{\"id\": \"01f0f3c11775127b949ac14d725d357d\",\"question\": [\"Show me patients who were diagnosed with \\\"chronic congestive heart failure\\\", exclude those with \\\"alteplase 100 MG Injection\\\", and provide a summary of their demographics?\"],\"sql\": [\"WITH chf_concept AS (\\n\",\"SELECT\\n\",\"concept_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`concept`\\n\",\"WHERE\\n\",\"concept_name ILIKE '%chronic congestive heart failure%'\\n\",\"),\\n\",\"alteplase_concept AS (\\n\",\"SELECT\\n\",\"concept_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`concept`\\n\",\"WHERE\\n\",\"concept_name ILIKE '%alteplase 100 MG Injection%'\\n\",\"),\\n\",\"chf_descendants AS (\\n\",\"SELECT\\n\",\"descendant_concept_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`concept_ancestor`\\n\",\"WHERE\\n\",\"ancestor_concept_id IN (\\n\",\"SELECT\\n\",\"concept_id\\n\",\"FROM\\n\",\"chf_concept\\n\",\")\\n\",\"),\\n\",\"alteplase_descendants AS (\\n\",\"SELECT\\n\",\"descendant_concept_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`concept_ancestor`\\n\",\"WHERE\\n\",\"ancestor_concept_id IN (\\n\",\"SELECT\\n\",\"concept_id\\n\",\"FROM\\n\",\"alteplase_concept\\n\",\")\\n\",\"),\\n\",\"chf_patients AS (\\n\",\"SELECT DISTINCT\\n\",\"person_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`condition_occurrence`\\n\",\"WHERE\\n\",\"condition_concept_id IN (\\n\",\"SELECT\\n\",\"descendant_concept_id\\n\",\"FROM\\n\",\"chf_descendants\\n\",\")\\n\",\"),\\n\",\"alteplase_patients AS (\\n\",\"SELECT DISTINCT\\n\",\"person_id\\n\",\"FROM\\n\",\"`vantage_rwe`.`omop`.`drug_exposure`\\n\",\"WHERE\\n\",\"drug_concept_id IN (\\n\",\"SELECT\\n\",\"descendant_concept_id\\n\",\"FROM\\n\",\"alteplase_descendants\\n\",\")\\n\",\"),\\n\",\"final_patients AS (\\n\",\"SELECT\\n\",\"person_id\\n\",\"FROM\\n\",\"chf_patients\\n\",\"WHERE\\n\",\"person_id NOT IN (\\n\",\"SELECT\\n\",\"person_id\\n\",\"FROM\\n\",\"alteplase_patients\\n\",\")\\n\",\")\\n\",\"SELECT\\n\",\"COUNT(*) AS patient_count,\\n\",\"AVG(EXTRACT(YEAR FROM CURRENT_DATE) - year_of_birth) AS avg_age,\\n\",\"p.gender_concept_id,\\n\",\"c_gender.concept_name AS gender,\\n\",\"p.race_concept_id,\\n\",\"c_race.concept_name AS race,\\n\",\"p.ethnicity_concept_id,\\n\",\"c_ethnicity.concept_name AS ethnicity\\n\",\"FROM\\n\",\"final_patients fp\\n\",\"JOIN `vantage_rwe`.`omop`.`person` p\\n\",\"ON fp.person_id = p.person_id\\n\",\"LEFT JOIN `vantage_rwe`.`omop`.`concept` c_gender\\n\",\"ON p.gender_concept_id = c_gender.concept_id\\n\",\"LEFT JOIN `vantage_rwe`.`omop`.`concept` c_race\\n\",\"ON p.race_concept_id = c_race.concept_id\\n\",\"LEFT JOIN `vantage_rwe`.`omop`.`concept` c_ethnicity\\n\",\"ON p.ethnicity_concept_id = c_ethnicity.concept_id\\n\",\"GROUP BY\\n\",\"p.gender_concept_id,\\n\",\"c_gender.concept_name,\\n\",\"p.race_concept_id,\\n\",\"c_race.concept_name,\\n\",\"p.ethnicity_concept_id,\\n\",\"c_ethnicity.concept_name\\n\",\"ORDER BY\\n\",\"patient_count DESC\"]}}],\"join_specs\": [{{\"id\": \"01f0f3bd4846133c95aee2ee619b980e\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.person\",\"alias\": \"person\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.location\",\"alias\": \"location\"}},\"sql\": [\"`person`.`LOCATION_ID` = `location`.`LOCATION_ID`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd484615aead14e25cb5c23e89\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept\",\"alias\": \"concept\"}},\"sql\": [\"`provider`.`GENDER_CONCEPT_ID` = `concept`.`concept_id`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd48461bc4814e027bb45f7226\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept\",\"alias\": \"concept_2\"}},\"sql\": [\"`provider`.`SPECIALTY_SOURCE_CONCEPT_ID` = `concept_2`.`concept_id`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd48461dafae40cb8a7242bb93\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept\",\"alias\": \"concept_3\"}},\"sql\": [\"`provider`.`SPECIALTY_CONCEPT_ID` = `concept_3`.`concept_id`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd48461f2d84e0b112bc7f693b\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.concept\",\"alias\": \"concept_4\"}},\"sql\": [\"`provider`.`GENDER_SOURCE_CONCEPT_ID` = `concept_4`.`concept_id`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd484710d58c8daf3635a4bd75\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.condition_occurrence\",\"alias\": \"condition_occurrence\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"sql\": [\"`condition_occurrence`.`PROVIDER_ID` = `provider`.`PROVIDER_ID`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd484712beaa9dc26cba79e7d7\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.drug_exposure\",\"alias\": \"drug_exposure\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"sql\": [\"`drug_exposure`.`PROVIDER_ID` = `provider`.`PROVIDER_ID`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}},{{\"id\": \"01f0f3bd4847143da5a7cc4c593eeefa\",\"left\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.person\",\"alias\": \"person\"}},\"right\": {{\"identifier\": \"{CATALOG_NAME}.{SCHEMA_NAME}.provider\",\"alias\": \"provider\"}},\"sql\": [\"`person`.`PROVIDER_ID` = `provider`.`PROVIDER_ID`\",\"--rt=FROM_RELATIONSHIP_TYPE_MANY_TO_ONE--\"]}}]}}}}"
"""
g = w.genie.create_space(
    warehouse_id = WAREHOUSE_ID,
    title = GENIE_TITLE,
    description = GENIE_DESCRIPTION,
    serialized_space = SERIALIZED_SPACE
)

# COMMAND ----------

# MAGIC %md
# MAGIC # Step 5
# MAGIC ## Capture Genie Space ID for use in Databricks App

# COMMAND ----------

print("Genie Space ID: \n", g.space_id)